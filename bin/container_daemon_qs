#!/bin/sh

user=$(whoami)
repo="$IPFS_PATH"
config="$repo/config"
tmp_config="/tmp/config"

# Test whether the mounted directory is writable for us
if [ ! -w "$repo" 2>/dev/null ]; then
  echo "error: $repo is not writable for user $user (uid=$(id -u $user))"
  exit 1
fi

ipfs version

if [ -e $config ]; then
  echo "Found IPFS fs-repo at $repo"
else
  ipfs init -e

  if [ -n "$IPFS_PRIVATE_KEY" ]; then
    ipfs config Identity.PrivKey "$IPFS_PRIVATE_KEY"
  fi

  if [ -n "$IPFS_PEER_ID" ]; then
    ipfs config Identity.PeerID "$IPFS_PEER_ID"
  fi

  if [ -n "$IPFS_API_ADDRESS" ]; then
    ipfs config Addresses.API "$IPFS_API_ADDRESS"
  fi

  if [ -n "$IPFS_GATEWAY_ADDRESS" ]; then
    ipfs config Addresses.Gateway "$IPFS_GATEWAY_ADDRESS"
  fi

  if [ -n "$IPFS_DATASTORE_TYPE" ]; then
    ipfs config Datastore.Type "$IPFS_DATASTORE_TYPE"
  fi

  if [ -n "$IPFS_BOOTSTRAP_NODES" ]; then
    ipfs config --json Bootstrap "$IPFS_BOOTSTRAP_NODES"
  fi

  if [ -n "$IPFS_SUPERNODE_ROUTING_SERVERS" ]; then
    ipfs config --json SupernodeRouting.Servers "$IPFS_SUPERNODE_ROUTING_SERVERS"
  fi

  cp $config $tmp_config
  rm -rf $repo/*
  ipfs init -e < $tmp_config
  rm $tmp_config
fi

exec ipfs daemon
